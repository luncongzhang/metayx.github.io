---
layout: post
title:  "tcp的拥塞控制机制"
categories: java
tags: tcp三次握手 tcp四次挥手 TCP的拥塞控制机制 慢启动 拥塞避免 快速重传 快速恢复
---

* content
{:toc}

<!--more-->


# OSI七层网络模型与TCP/IP四层网络模型

## 由点及面，先看网络分层

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fx46vtaj5sj313q0miacf.jpg)

![](https://ws2.sinaimg.cn/large/006tNbRwgy1fx471ov87xj30f60lcwgc.jpg)

## tcp三次握手
为什么要三次握手？一端(client)A发出去的第一个连接请求报文并没有丢失，而是因为某些未知的原因在某个网络节点上发生滞留，导致延迟到连接释放以后的某个时间才到达另一端(server)B。本来这是一个早已失效的报文段，但是B收到此失效的报文之后，会误认为是A再次发出的一个新的连接请求，于是B端就向A又发出确认报文，表示同意建立连接。如果不采用“三次握手”，那么只要B端发出确认报文就会认为新的连接已经建立了，但是A端并没有发出建立连接的请求，因此不会去向B端发送数据，B端没有收到数据就会一直等待，这样B端就会白白浪费掉很多资源。如果采用“三次握手”的话就不会出现这种情况，B端收到一个过时失效的报文段之后，向A端发出确认，此时A并没有要求建立连接，所以就不会向B端发送确认，这个时候B端也能够知道连接没有建立。

![](https://ws3.sinaimg.cn/large/006tNbRwgy1fx46yyszfsj310w0rin0d.jpg)

## tcp四次挥手
为什么要四次挥手？本质的原因是tcp是全双公的，要实现可靠的连接关闭，A发出结束报文FIN，收到B确认后A知道自己没有数据需要发送了，B知道A不再发送数据了，自己也不会接收数据了，但是此时A还是可以接收数据，B也可以发送数据；当B发出FIN报文的时候此时两边才会真正的断开连接，读写分开。
为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态？
虽然按道理，四个报文都发送完毕，我们可以直接进入CLOSE状态了，但是我们必须假象网络是不可靠的，有可以最后一个ACK丢失。所以TIME_WAIT状态就是用来重发可能丢失的ACK报文。

![](https://ws1.sinaimg.cn/large/006tNbRwgy1fx46z2o102j310y0qc78r.jpg)

## tcp的拥塞控制机制

### 慢开始

1.慢开始不是指cwnd的增长速度慢（指数增长），而是指TCP开始发送设置cwnd=1。 
2.思路：不要一开始就发送大量的数据，先探测一下网络的拥塞程度，也就是说由小到大逐渐增加拥塞窗口的大小。这里用报文段的个数的拥塞窗口大小举例说明慢开始算法，实时拥塞窗口大小是以字节为单位的。如下图：
![](https://ws4.sinaimg.cn/large/006tNbRwgy1fx47vdf3nvj30w60h20xk.jpg)
3.为了防止cwnd增长过大引起网络拥塞，设置一个慢开始门限（ssthresh状态变量） 
当cnwd＜ssthresh，使用慢开始算法 
当cnwd=ssthresh，既可使用慢开始算法，也可以使用拥塞避免算法 
当cnwd＞ssthresh，使用拥塞避免算法

### 拥塞避免（按线性规律增长）

1.拥塞避免并非完全能够避免拥塞，是说在拥塞避免阶段将拥塞窗口控制为按线性规律增长，使网络比较不容易出现拥塞。 
2.思路：让拥塞窗口cwnd缓慢地增大，即每经过一个往返时间RTT就把发送方的拥塞控制窗口加一。

![](https://ws4.sinaimg.cn/large/006tNbRwgy1fx47wydup9j30t40euta2.jpg)

无论是在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络出现拥塞（其根据就是没有收到确认，虽然没有收到确认可能是其他原因的分组丢失，但是因为无法判定，所以都当做拥塞来处理），就把慢开始门限设置为出现拥塞时的发送窗口大小的一半。然后把拥塞窗口设置为1，执行慢开始算法。 

### 快重传与快恢复

![](https://ws1.sinaimg.cn/large/006tNbRwgy1fx47ywdt85j312w0hcwi9.jpg)

#### 快重传

快重传要求接收方在收到一个失序的报文段后就立即发出重复确认（为的是使发送方及早知道有报文段没有到达对方）而不要等到自己发送数据时捎带确认。快重传算法规定，发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段，而不必继续等待设置的重传计时器时间到期。 

![](https://ws4.sinaimg.cn/large/006tNbRwgy1fx4829gnyzj30ts0fswgq.jpg)

#### 快恢复

1.采用快恢复算法时，慢开始只在TCP连接建立时和网络出现超时时才使用。 
2.当发送方连续收到三个重复确认时，就执行“乘法减小”算法，把ssthresh门限减半。但是接下去并不执行慢开始算法。 
3.考虑到如果网络出现拥塞的话就不会收到好几个重复的确认，所以发送方现在认为网络可能没有出现拥塞。所以此时不执行慢开始算法，而是将cwnd设置为ssthresh的大小，然后执行拥塞避免算法。



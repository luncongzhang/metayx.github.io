---
layout: post
title:  "linux防火墙之netfilter/iptables"
categories: java
tags: netfilter iptables 防火墙  
---

* content
{:toc}

<!--more-->

# 前言

netfilter 组件也称为内核空间（kernelspace），是内核的一部分，由一些信息包过滤表组成，这些表包含内核用来控制信息包过滤处理的规则集。

iptables 组件是一种工具，也称为用户空间（userspace），它使插入、修改和除去信息包过滤表中的规则变得容易。

![](https://ws4.sinaimg.cn/large/006tKfTcgy1g09j2vfkeoj31da0qsq3e.jpg)


# 表

默认表是filter（没有指定表的时候就是filter表）。表的处理优先级：raw>mangle>nat>filter。

* filter表：负责过滤功能，防火墙；内核模块：iptables_filter

* nat表：network address translation，网络地址转换功能；内核模块：iptable_nat

* mangle表：拆解报文，做出修改，并重新封装 的功能；iptable_mangle

* raw表：关闭nat表上启用的连接追踪机制；iptable_raw

# 链

 * PREROUTING:前置路由，数据包进入路由表之前,用于目标地址转换（DNAT）。

 * INPUT:通过路由表后目的地为本机,处理输入数据包。

 * FORWARDING:通过路由表后，目的地不为本机,处理转发数据包。

 * OUTPUT:由本机产生，向外转发,处理输出数据包。

 * POSTROUTIONG:后置路由，发送到网卡接口之前,用于源地址转换（SNAT）。

# 处理动作

* ACCEPT：接收数据包。
* DROP：丢弃数据包。
* REDIRECT：重定向、映射、透明代理。
* SNAT：源地址转换。
* DNAT：目标地址转换。
* MASQUERADE：IP伪装（NAT），用于ADSL。
* LOG：日志记录。

# 表和链之间的关系


![](https://ws3.sinaimg.cn/large/006tKfTcgy1g09jb4ohy8j30oq0m6myk.jpg)

# 数据经过防火墙的流程

![](https://ws4.sinaimg.cn/large/006tKfTcgy1g09jlu6jomj318g0mhdhc.jpg)

# iptables命令

命令：

```
iptables(选项)(参数)
```

语法：

```

-t<表>：指定要操纵的表；
-A：向规则链中添加条目；
-D：从规则链中删除条目；
-i：向规则链中插入条目；
-R：替换规则链中的条目；
-L：显示规则链中已有的条目；
-F：清楚规则链中已有的条目；
-Z：清空规则链中的数据包计算器和字节计数器；
-N：创建新的用户自定义规则链；
-P：定义规则链中的默认目标；
-h：显示帮助信息；
-p：指定要匹配的数据包协议类型；
-s：指定要匹配的数据包源ip地址；
-j<目标>：指定要跳转的目标；
-i<网络接口>：指定数据包进入本机的网络接口；
-o<网络接口>：指定数据包要离开本机所使用的网络接口。

```

iptables命令选项输入顺序：

```
iptables -t 表名 <-A/I/D/R> 规则链名 [规则号] <-i/o 网卡名> -p 协议名 <-s 源IP/源子网> --sport 源端口 <-d 目标IP/目标子网> --dport 目标端口 -j 动作

```

举例：

清除已有iptables规则

```
iptables -F
iptables -X
iptables -Z

```

查看已添加的iptables规则

```
iptables -L -n -v
```

```
Chain INPUT (policy DROP 48106 packets, 2690K bytes)
 pkts bytes target     prot opt in     out     source               destination         
 5075  589K ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0           
 191K   90M ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:22
1499K  133M ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:80
4364K 6351M ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED
 6256  327K ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 3382K packets, 1819M bytes)
 pkts bytes target     prot opt in     out     source               destination         
 5075  589K ACCEPT     all  --  *      lo      0.0.0.0/0            0.0.0.0/0  
```

开放指定的端口

```
iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT               #允许本地回环接口(即运行本机访问本机)
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT    #允许已建立的或相关连的通行
iptables -A OUTPUT -j ACCEPT         #允许所有本机向外的访问
iptables -A INPUT -p tcp --dport 22 -j ACCEPT    #允许访问22端口
iptables -A INPUT -p tcp --dport 80 -j ACCEPT    #允许访问80端口
iptables -A INPUT -p tcp --dport 21 -j ACCEPT    #允许ftp服务的21端口
iptables -A INPUT -p tcp --dport 20 -j ACCEPT    #允许FTP服务的20端口
iptables -A INPUT -j reject       #禁止其他未允许的规则访问
iptables -A FORWARD -j REJECT     #禁止其他未允许的规则访问
```

屏蔽IP

```
iptables -I INPUT -s 123.45.6.7 -j DROP       #屏蔽单个IP的命令
iptables -I INPUT -s 123.0.0.0/8 -j DROP      #封整个段即从123.0.0.1到123.255.255.254的命令
iptables -I INPUT -s 124.45.0.0/16 -j DROP    #封IP段即从123.45.0.1到123.45.255.254的命令
iptables -I INPUT -s 123.45.6.0/24 -j DROP    #封IP段即从123.45.6.1到123.45.6.254的命令是
```

删除已添加的iptables规则

将所有iptables以序号标记显示，执行：

```
iptables -L -n --line-numbers
```

比如要删除INPUT里序号为8的规则，执行：

```
iptables -D INPUT 8
```




